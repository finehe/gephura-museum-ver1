var e=Object.defineProperty,o=(o,t,s)=>(((o,t,s)=>{t in o?e(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s})(o,"symbol"!=typeof t?t+"":t,s),s);import{J as t,p as s,K as n,L as a,M as i,N as l,a as c,H as r,y as u,d,e as h,o as g,c as f,w as m,g as k,h as p,t as T,E as b,n as I,k as _,C as w,l as y,i as C,I as L,O as S}from"./index-B3zB-9EW.js";class v{constructor(e,o){this.event=e,this.data=o}}class P{constructor(e,t=!0){if(o(this,"socketUrl",""),o(this,"onMessage",null),o(this,"logInfo",!0),o(this,"connected",!1),o(this,"socketTask",null),o(this,"heartbeatTimer",null),o(this,"heartbeatIntervalTime",3e4),o(this,"reconnectTimer",null),o(this,"reconnectDelayTime",3e3),o(this,"reconnectTimes",0),o(this,"reconnectMaxTimes",100),o(this,"closeFlag",!0),"function"!=typeof e)throw Error("onMessage åº”è¯¥æ˜¯ä¸€ä¸ªå‡½æ•°");this.onMessage=e,this.logInfo=t}init(e,o="init"){return new Promise((async(s,n)=>{try{if(this.socketUrl=e||this.socketUrl,!this.socketUrl||"string"!=typeof this.socketUrl)return n("socketUrl åº”è¯¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²");if(this.logInfo&&console.log("------ WebSocket åˆå§‹åŒ– ------"),this.connected)return;this.socketTask=t({url:this.socketUrl,complete:()=>{}}),this.socketTask.onOpen((e=>{this.logInfo&&console.log(`------ WebSocket è¿æ¥åˆ°æœåŠ¡å™¨, typeï¼š${o} ------`,e),s(e),this.connected=!0,this.closeFlag=!1,this.reconnectTimes=0,this.heartbeat()})),this.socketTask.onMessage((({data:e})=>{this.logInfo&&console.log("------ WebSocket æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯ ------",e);try{if("string"==typeof e){const o=JSON.parse(e);"ping"!=o.event&&"pong"!=o.event&&this.onMessage(o)}e instanceof ArrayBuffer&&this.onMessage(e)}catch(o){this.logInfo&&console.log("------ WebSocket é¢„å¤„ç†æ¶ˆæ¯é”™è¯¯ ------",o)}})),this.socketTask.onError((e=>{this.connected=!1,this.logInfo&&console.log("------ WebSocket é”™è¯¯ä¿¡æ¯ ------",e)})),this.socketTask.onClose((({code:e,reason:o})=>{this.connected=!1,this.logInfo&&console.log("------ WebSocket è¿æ¥å…³é—­ ------",e,o),this.reconnect()}))}catch(a){n(a)}}))}send(e,o=!0){return this.connected?e instanceof v||!o?new Promise(((o,t)=>{this.logInfo&&console.log("------ WebSocket å‘é€æ¶ˆæ¯ ------",e),this.socketTask.send({data:JSON.stringify(e),success:o,fail:t})})):Promise.reject("æ¶ˆæ¯æ ¼å¼é”™è¯¯"):Promise.reject("WebSocket è¿æ¥æœªå¼€å¯")}heartbeat(){this.send(new v("ping")).catch(console.log),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval((()=>{this.connected?this.send(new v("ping")).catch(console.log):this.reconnect()}),this.heartbeatIntervalTime)}reconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.closeFlag||this.reconnectTimes>=this.reconnectMaxTimes||(this.reconnectTimer=setTimeout((()=>{this.logInfo&&console.log("------ WebSocket å°è¯•é‡è¿ ------"),this.init(this.socketUrl,"reconnect").catch(console.log),this.reconnectTimes++}),this.reconnectDelayTime))}close(e={}){return this.closeFlag=!0,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.connected?new Promise(((o,t)=>{this.socketTask.close({...e,success:o,fail:t,complete:()=>{this.connected=!1}})})):console.error("WebSocket è¿æ¥æœªå¼€å¯")}}let F=null;const x="https://api.functionpoint.cn/museum";function O(e){if(!F||!F.connected){F=new P(e,!1);let o=E();return F.init(`wss://api.functionpoint.cn/museum/websocket?token=${o}`)}}function $(){F&&(F.close(),console.log("WebSocket connection closed"))}function M(e,o,t,c){const r=E();if(!r)return console.error("Token not found"),void s({title:"æœªæ‰¾åˆ°æˆæƒä¿¡æ¯",icon:"none"});console.log("å½“å‰å¹³å°:",n().platform),console.log("è¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„:",e),a({title:"ä¸Šä¼ ä¸­..."}),i({url:`${x}/chat/uploadImage`,filePath:e,name:"file",header:{Authorization:`Bearer ${r}`},formData:{uid:o,uuid:t},success:e=>{console.log("ä¸Šä¼ æˆåŠŸï¼ŒçŠ¶æ€ç :",e.statusCode),console.log("è¿”å›æ•°æ®:",e.data);try{let o=JSON.parse(e.data),t=JSON.stringify(o.data);c(t)}catch(o){console.error("è§£æè¿”å›æ•°æ®å¤±è´¥:",o),s({title:"è§£æè¿”å›æ•°æ®å¤±è´¥",icon:"none"})}},fail:e=>{console.error("ä¸Šä¼ å¤±è´¥:",e),s({title:"ä¸Šä¼ å›¾ç‰‡å¤±è´¥: "+(e.errMsg||"æœªçŸ¥é”™è¯¯"),icon:"none",duration:3e3})},complete:()=>{l()}})}function U(e,o,t,s){c({url:`${x}/scan`,method:"POST",data:{result:e,uid:o,uuid:t},success:e=>{s(e.data)}})}function E(){const e=r("token"),o=r("tokenExpire");return Date.now()>o?(u("token"),u("tokenExpire"),u("userInfo"),null):e}function W(e){let o=r("userInfo");o?e(o):function(e){const o=E(),t={};o&&(t.Authorization=`Bearer ${o}`),c({url:`${x}/user/info`,method:"GET",header:t,data:{auto:1},success:o=>{e(o.data)},fail:e=>{console.error("Failed to fetch user info:",e)}})}((t=>{o=t.data,o&&o.token&&(d("userInfo",o),function(e){const{token:o,tokenExpire:t}=e,s=Date.now()+t;d("token",o),d("tokenExpire",s)}(o)),e(o)}))}function A(e,o,t,s){const n=E();n?c({url:`${x}/chat/talk`,method:"POST",header:{Authorization:`Bearer ${n}`},data:{chatGroupId:e,uuid:o,message:t},success:e=>{console.log("Response from server:",e.data),s&&s(e.data)},fail:e=>{console.error("Failed to send message:",e)}}):console.error("Token not found")}function D(e,o,t,s){const n=E();n?c({url:`${x}/chat/audio`,method:"POST",header:{Authorization:`Bearer ${n}`},data:{chatLogId:e,uuid:o,logGroupId:t},success:e=>{console.log("Audio response:",e.data),s&&s(e.data)},fail:e=>{console.error("Failed to play audio:",e)}}):console.error("Token not found")}function N(e,o,t,s,n){const a=E();a?c({url:`${x}/chat/uploadText`,method:"POST",header:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},data:{chatGroupId:e,uuid:o,uid:t,message:s,type:"TEXT"},success:e=>{console.log("Upload text response:",e.data),n&&n(e.data)},fail:e=>{console.error("Failed to upload text:",e)}}):console.error("Token not found")}function j(e){const o=E();return o?new Promise(((t,s)=>{c({url:`${x}/chat/chatDetail`,method:"POST",header:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},data:e,success:e=>{t(e.data)},fail:e=>{console.error("Failed to fetch chat detail:",e),s(e)}})})):(console.error("Token not found"),Promise.reject("Token not found"))}function B(e,o,t){const s=E();return s?new Promise(((n,a)=>{c({url:`${x}/chat/startConversation`,method:"POST",header:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},data:{uid:e,uuid:o,message:t},success:e=>{console.log("Response from server:",e),200===e.statusCode?n(e.data):(console.error("Failed to start conversation:",e.data.message||"No message"),a(e.data.message||"No message"))},fail:e=>{console.error("Error starting conversation:",e),a(e)}})})):(console.error("Token not found"),Promise.reject("Token not found"))}const z=(e,o)=>{const t=e.__vccOpts||e;for(const[s,n]of o)t[s]=n;return t};const V=z({name:"SidebarNav",data:()=>({isOpen:!1,isLoggedIn:!1,userInfo:{},showLoginDialog:!1,isPasswordLogin:!1,loginForm:{username:"",password:"",agreement:!1}}),created(){this.checkLoginStatus()},methods:{checkLoginStatus(){const e=E();this.isLoggedIn=!!e,this.isLoggedIn&&this.getUserInfo()},getUserInfo(){const e=r("userInfo");e?this.userInfo=e:W((e=>{this.userInfo=e}))},toggleSidebar(){this.isOpen=!this.isOpen},goToHistory(){h({url:"/pages/history/history"})},startNewChat(){h({url:"/pages/home/home"})},goToSettings(){h({url:"/pages/settings/settings"})},showLoginModal(){this.isOpen=!1,this.showLoginDialog=!0,this.isPasswordLogin=!1},closeLoginModal(){this.showLoginDialog=!1,this.loginForm={username:"",password:"",agreement:!1}},switchToPasswordLogin(){this.isPasswordLogin=!0},switchToWechatLogin(){this.isPasswordLogin=!1},submitLogin(){this.loginForm.username?this.loginForm.password?this.loginForm.agreement?(a({title:"ç™»å½•ä¸­..."}),setTimeout((()=>{l();const e={uid:"123456",uuid:"user-123456",nickname:"æµ‹è¯•ç”¨æˆ·",avatarUrl:"",token:"mock-token",tokenExpire:6048e5};d("userInfo",e),d("token",e.token),d("tokenExpire",Date.now()+e.tokenExpire),this.isLoggedIn=!0,this.userInfo=e,this.closeLoginModal(),s({title:"ç™»å½•æˆåŠŸ",icon:"success"})}),1500)):s({title:"è¯·åŒæ„æœåŠ¡åè®®",icon:"none"}):s({title:"è¯·è¾“å…¥å¯†ç ",icon:"none"}):s({title:"è¯·è¾“å…¥è´¦å·",icon:"none"})},login(){h({url:"/pages/login/login"})},logout(){u("token"),u("tokenExpire"),u("userInfo"),this.isLoggedIn=!1,this.userInfo={},s({title:"å·²é€€å‡ºç™»å½•",icon:"none"})}}},[["render",function(e,o,t,s,n,a){const i=_,l=w,c=y,r=C,u=L,d=S;return g(),f(r,null,{default:m((()=>[k(r,{class:I(["sidebar",{open:n.isOpen}])},{default:m((()=>[k(i,{src:"/assets/logo-B5n3nu2_.png",class:"sidebar-logo",alt:"Logo"}),n.isOpen?(g(),f(r,{key:0,class:"sidebar-content"},{default:m((()=>[k(l,{class:"sidebar-button",onClick:a.goToHistory},{default:m((()=>[p("å†å²å¯¹è¯")])),_:1},8,["onClick"]),k(l,{class:"sidebar-button",onClick:a.startNewChat},{default:m((()=>[p("+æ–°å¯¹è¯")])),_:1},8,["onClick"]),k(l,{class:"sidebar-button",onClick:a.goToSettings},{default:m((()=>[p("ä¸ªäººè®¾ç½®")])),_:1},8,["onClick"]),k(r,{class:"user-section"},{default:m((()=>[n.isLoggedIn?(g(),f(r,{key:0,class:"user-info"},{default:m((()=>[k(i,{class:"user-avatar",src:n.userInfo.avatarUrl||"/static/default-avatar.png"},null,8,["src"]),k(r,{class:"user-details"},{default:m((()=>[k(c,{class:"username"},{default:m((()=>[p(T(n.userInfo.nickname||"ç”¨æˆ·"),1)])),_:1}),k(l,{class:"logout-button",onClick:a.logout},{default:m((()=>[p("é€€å‡ºç™»å½•")])),_:1},8,["onClick"])])),_:1})])),_:1})):(g(),f(r,{key:1,class:"login-button-container",onClick:a.showLoginModal},{default:m((()=>[k(r,{class:"login-avatar-circle"},{default:m((()=>[k(c,{class:"login-avatar-icon"},{default:m((()=>[p("ğŸ‘¤")])),_:1})])),_:1}),k(c,{class:"login-text"},{default:m((()=>[p("ç«‹å³ç™»å½•")])),_:1})])),_:1},8,["onClick"]))])),_:1})])),_:1})):b("",!0)])),_:1},8,["class"]),n.isOpen?(g(),f(r,{key:0,class:"overlay",onClick:a.toggleSidebar},null,8,["onClick"])):b("",!0),n.showLoginDialog?(g(),f(r,{key:1,class:"login-modal-overlay"},{default:m((()=>[k(r,{class:"login-modal"},{default:m((()=>[n.isPasswordLogin?(g(),f(r,{key:1},{default:m((()=>[k(r,{class:"login-modal-header"},{default:m((()=>[k(c,{class:"login-modal-title"},{default:m((()=>[p("çµé©¬AIå’¨è¯¢å¹³å°è´¦å·ç™»å½•")])),_:1}),k(c,{class:"login-modal-close",onClick:a.closeLoginModal},{default:m((()=>[p("Ã—")])),_:1},8,["onClick"])])),_:1}),k(r,{class:"login-modal-body password-login-body"},{default:m((()=>[k(r,{class:"input-group"},{default:m((()=>[k(c,{class:"input-label required"},{default:m((()=>[p("è´¦å·")])),_:1}),k(u,{class:"login-input",type:"text",modelValue:n.loginForm.username,"onUpdate:modelValue":o[0]||(o[0]=e=>n.loginForm.username=e),placeholder:"è¯·è¾“å…¥è´¦å·"},null,8,["modelValue"])])),_:1}),k(r,{class:"input-group"},{default:m((()=>[k(c,{class:"input-label required"},{default:m((()=>[p("å¯†ç ")])),_:1}),k(u,{class:"login-input",type:"password",modelValue:n.loginForm.password,"onUpdate:modelValue":o[1]||(o[1]=e=>n.loginForm.password=e),placeholder:"è¯·è¾“å…¥å¯†ç "},null,8,["modelValue"])])),_:1}),k(r,{class:"agreement-checkbox"},{default:m((()=>[k(d,{checked:n.loginForm.agreement,onChange:o[2]||(o[2]=e=>n.loginForm.agreement=e.detail.value),color:"#007bff"},null,8,["checked"]),k(c,{class:"agreement-label"},{default:m((()=>[p("åŒæ„ã€Šçµé©¬AIæœåŠ¡åè®®ã€‹")])),_:1})])),_:1}),k(l,{class:"submit-button",onClick:a.submitLogin},{default:m((()=>[p("ç«‹å³ç™»å½•")])),_:1},8,["onClick"])])),_:1}),k(r,{class:"login-modal-footer"},{default:m((()=>[k(c,{class:"switch-login-mode",onClick:a.switchToWechatLogin},{default:m((()=>[p("åˆ‡æ¢å¾®ä¿¡ç™»å½•")])),_:1},8,["onClick"])])),_:1})])),_:1})):(g(),f(r,{key:0},{default:m((()=>[k(r,{class:"login-modal-header"},{default:m((()=>[k(c,{class:"login-modal-title"},{default:m((()=>[p("è¯·å¾®ä¿¡æ‰«ç æ³¨å†Œ/ç™»å½•")])),_:1}),k(c,{class:"login-modal-close",onClick:a.closeLoginModal},{default:m((()=>[p("Ã—")])),_:1},8,["onClick"])])),_:1}),k(r,{class:"login-modal-body"},{default:m((()=>[k(i,{class:"qrcode-image",src:"/static/qrcode.png",mode:"aspectFit"}),k(c,{class:"wx-login-text"},{default:m((()=>[p("å¾®ä¿¡æˆæƒç™»å½•")])),_:1})])),_:1}),k(r,{class:"login-modal-footer"},{default:m((()=>[k(c,{class:"agreement-text"},{default:m((()=>[p("æ‰«ç ç™»å½•å³åŒæ„ã€Šçµé©¬AIæœåŠ¡åè®®ã€‹")])),_:1}),k(c,{class:"switch-login-mode",onClick:a.switchToPasswordLogin},{default:m((()=>[p("è´¦å·å¯†ç ç™»å½•")])),_:1},8,["onClick"])])),_:1})])),_:1}))])),_:1})])),_:1})):b("",!0)])),_:1})}],["__scopeId","data-v-96f534d0"]]);export{V as S,z as _,B as a,O as b,$ as c,D as d,N as e,x as f,j as g,W as i,U as s,A as t,M as u};
